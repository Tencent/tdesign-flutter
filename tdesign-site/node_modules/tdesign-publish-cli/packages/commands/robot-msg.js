const fs = require('fs');

const rootPath = process.cwd();
const appInfo = require(`${rootPath}/package.json`);
const inquirer = require('inquirer');

const readmeFilePath = `${rootPath}/CHANGELOG.md`;
const TEMPLATES = {
  PUBLISH: 'å‘ç‰ˆé€šçŸ¥',
  ENCOURAGE: 'å³æ—¶æ¿€åŠ±',
};

function generatePostBody(content) {
  return {
    msgtype: 'markdown',
    markdown: {
      content,
    },
  };
}

const {
  name: appName, version, homepage = '', bugs, repository,
} = appInfo;
let repoName = '';
let issueLink = '';
let repoLink = '';
if (bugs && bugs.url) {
  issueLink = bugs.url;
}
if (repository && repository.url) {
  repoLink = repository.url;
  repoName = repoLink.match(/(?<=com\/).+/);
}

async function generatePublishInfo(targetVersion) {
  if (!fs.existsSync(readmeFilePath)) {
    console.log('\x1b[33m%s\x1b[0m', `æœªæ‰¾åˆ° ${readmeFilePath} ï¼Œè¯·ä½¿ç”¨ npm run changelog ç”Ÿæˆã€‚`);
    return;
  }
  const changelogStr = fs.readFileSync(readmeFilePath, 'utf8');
  const currentVersion = changelogStr.match(new RegExp(`(?<=## ğŸŒˆ ${targetVersion} .*\n).+?(?=\n## ğŸŒˆ \\d+.\\d+.\\d+)`, 's'));

  if (!currentVersion) {
    console.log('\x1b[33m%s\x1b[0m', `æœªæ‰¾åˆ°${targetVersion}å¯¹åº”çš„ changelog å‘å¸ƒä¿¡æ¯`);
    return;
  }

  const template = `### ${appName} å‘å¸ƒ\n\n.\n\n- ç‰ˆæœ¬ï¼š<font color="comment">${targetVersion}</font>\n- npmï¼š[${appName}](https://npmjs.com/package/${appName})\n${repoName && `- GitHubï¼š[${repoName}](${repoLink})\n`}${issueLink && `- issue: [issue](${issueLink})\n`}${homepage && `- æ–‡æ¡£ï¼š[${homepage}](${homepage})\n`}\n\n`;
  let content = template.concat(currentVersion[0]).replaceAll('###', '\n\n###');
  const msg = generatePostBody(content);
  fs.writeFileSync(`${rootPath}/robotMsg.json`, JSON.stringify(msg), 'utf8');
  console.log('\x1B[32m%s\x1B[0m', 'å·²ç”Ÿæˆä¼å¾®æœºå™¨äººæ¶ˆæ¯è¯·æ‰“å¼€ robotMsg.json ç¡®è®¤');
}

async function generateEncourageInfo(encourageList, encourageMonth) {
  const users = encourageList.split(',').map((user) => `<@${user}>`);
  const content = `æ­å–œ ${users.join(' ')} è·å¾— ${encourageMonth} æœŸ Oteam å³æ—¶æ¿€åŠ±ï¼Œæ„Ÿè°¢å„ä½åŒå­¦ä¸º TDesign å»ºè®¾åšå‡ºçš„è´¡çŒ®ï¼Œæ¦œå•è¯¦ç»†ä¿¡æ¯è§ï¼š[https://techmap.woa.com/article/761](https://techmap.woa.com/article/761)`;
  const msg = generatePostBody(content);
  fs.writeFileSync(`${rootPath}/robotMsg.json`, JSON.stringify(msg), 'utf8');
  console.log('\x1B[32m%s\x1B[0m', 'å·²ç”Ÿæˆä¼å¾®æœºå™¨äººæ¶ˆæ¯è¯·æ‰“å¼€ robotMsg.json ç¡®è®¤');
}

function generateRobotMsg() {
  inquirer
    .prompt([
      {
        type: 'list',
        message: 'è¯·é€‰æ‹©æ¨¡æ¿',
        name: 'template',
        choices: [
          {
            name: TEMPLATES.PUBLISH,
            checked: true,
          },
          {
            name: TEMPLATES.ENCOURAGE,
          },
        ],
        validate(answer) {
          if (answer.length < 1) {
            return 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¨¡æ¿';
          }
          return true;
        },
      },
      {
        type: 'confirm',
        name: 'versionConfirm',
        message: `ä½ æƒ³è¦ç”Ÿæˆ ${appName}@${version} åŒ…çš„å‘å¸ƒæ—¥å¿—ä¹ˆï¼Ÿ`,
        default: true,
        when(answers) {
          return answers.template === TEMPLATES.PUBLISH;
        },
      },
      {
        type: 'input',
        name: 'customVersion',
        message: 'è¯·è¾“å…¥ä½ æƒ³è¦ä½¿ç”¨çš„ç‰ˆæœ¬å·',
        when(answers) {
          return !answers.versionConfirm && answers.template === TEMPLATES.PUBLISH;
        },
      },
      {
        type: 'input',
        name: 'encourageList',
        message: 'è¯·è¾“å…¥è¦è¡¨å½°çš„äººå‘˜ï¼Œå¤šä¸ªæ—¶ä»¥è‹±æ–‡é€—å· "," åˆ†éš”',
        when(answers) {
          return answers.template === TEMPLATES.ENCOURAGE;
        },
      },
      {
        type: 'input',
        name: 'encourageMonth',
        message: 'è¯·è¾“å…¥å³æ—¶æ¿€åŠ±æ¦œå•æœŸæ•°',
        when(answers) {
          return answers.template === TEMPLATES.ENCOURAGE;
        },
      },
    ])
    .then(async (answers) => {
      const {
        template, customVersion, encourageList, encourageMonth,
      } = answers;
      if (template === TEMPLATES.PUBLISH) {
        await generatePublishInfo(customVersion || version);
      } else {
        await generateEncourageInfo(encourageList, encourageMonth);
      }
    });
}

module.exports = generateRobotMsg;
