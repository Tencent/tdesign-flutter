name: PREVIEW_BUILD

on:
  pull_request:
    branches: [develop, main]
    types: [opened, synchronize, reopened]

jobs:
  tdesign-flutter-site:
    runs-on: ubuntu-latest
    steps:

      - name: Configure Git to not use symlinks
        run: git config --global core.symlinks false

      - uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true


      - name: Set Node version
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: tdesign-site/package-lock.json

      - uses: actions/setup-java@v5
        with:
          distribution: "jetbrains"
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: "12"
        env:
          SKIP_JDK_VERSION_CHECK: true

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.32.0
          channel: stable
      - run: |
          flutter --version
          cd ${{ env.FLUTTER_ROOT }}
          curl -L https://raw.githubusercontent.com/TDesignOteam/tdesign-flutter-aop-registry/main/patch_flutter/3.24~3.32.patch | git apply --allow-empty
          git status
          rm bin/cache/flutter_tools.stamp
      - name: Extract version from pubspec.yaml and set env
        id: version
        run: |
          # 从pubspec.yaml中提取版本号
          VERSION=$(grep "version:" tdesign-component/pubspec.yaml | sed 's/version: //g' | xargs)
          echo "Version from pubspec.yaml: $VERSION"
          # 分解版本号为主版本号、特性版本号和修正版本号
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          FIX=$(echo $VERSION | cut -d. -f3)
          # 输出变量以便后续步骤使用
          echo "major_version=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor_version=$MINOR" >> $GITHUB_OUTPUT
          echo "fix_version=$FIX" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create build environment file
        run: |
          # 创建包含所有构建环境变量的文件
          cat > build-env.txt << EOF
          MAJOR_VERSION=${{ steps.version.outputs.major_version }}
          MINOR_VERSION=${{ steps.version.outputs.minor_version }}
          FIX_VERSION=${{ steps.version.outputs.fix_version }}
          VERSION=${{ steps.version.outputs.version }}
          BUILD_NUMBER=${{ github.run_number }}
          DEVOPS_UUID=${{ github.run_id }}
          GIT_VERSION=${{ github.sha }}
          PR_NUMBER=${{ github.event.number }}
          SHA=${{ github.sha }}
          EOF
          echo "=== Build environment file created ==="
          cat build-env.txt

      - name: Upload build environment
        uses: actions/upload-artifact@v4
        with:
          name: build-env
          path: build-env.txt
          retention-days: 5
      - name: Get tdesign-flutter-generator
        uses: actions/checkout@v4
        with:
          repository: TDesignOteam/tdesign-flutter-generator
          path: ./example/tdesign-flutter-generator

      - name: Build Flutter apk
        run: |
          cd $GITHUB_WORKSPACE/tdesign-component/example
          flutter clean
          flutter doctor -v
          flutter devices
          flutter pub get --verbose
                    # Generate keystore for signing
          cd ${{ github.workspace }}/tdesign-component/example/android/app
          
          # Use simple fixed passwords instead of random ones
          STORE_PASSWORD="tdesign123456"
          KEY_PASSWORD="tdesign123456"
          keytool -genkeypair \
            -alias tdesign_flutter_debug_key \
            -keypass "$KEY_PASSWORD" \
            -keystore keystore.jks \
            -storepass "$STORE_PASSWORD" \
            -dname "CN=TDesign Flutter Test,O=TDesign,C=CN" \
            -keyalg RSA \
            -keysize 2048 \
            -validity 365
            
          # Ensure the keystore file has the correct permissions
          chmod 644 keystore.jks
          # Create key.properties in android directory (where build.gradle expects it)
          cd ${{ github.workspace }}/tdesign-component/example/android
          echo "storePassword=$STORE_PASSWORD" > key.properties
          echo "keyPassword=$KEY_PASSWORD" >> key.properties
          echo "keyAlias=tdesign_flutter_debug_key" >> key.properties
          echo "storeFile=keystore.jks" >> key.properties
          
          # Verify keystore file existence and properties file
          echo "Verifying keystore setup:"
          ls -la ${{ github.workspace }}/tdesign-component/example/android/app/keystore.jks || echo "Keystore file not found!"
          echo "Key.properties content (without passwords):"
          cat key.properties | grep -v "Password"
          cat android/local.properties || echo "File not found"
          echo "使用以下环境变量构建:"
          echo "MajorVersion: ${{ steps.version.outputs.major_version }}"
          echo "MinorVersion: ${{ steps.version.outputs.minor_version }}"
          echo "FixVersion: ${{ steps.version.outputs.fix_version }}"
          echo "BuildNo: ${{ github.run_number }}"
          echo "devopsUUID: ${{ github.run_id }}"
          echo "gitVersion: ${{ github.sha }}"
          # 使用环境变量构建
          flutter build apk --release \
            --dart-define=isCI=true \
            --dart-define=VersionCode=${{ github.run_number }} \
            --dart-define=devopsUUID=${{ github.run_id }} \
            --dart-define=MajorVersion=${{ steps.version.outputs.major_version }} \
            --dart-define=MinorVersion=${{ steps.version.outputs.minor_version }} \
            --dart-define=FixVersion=${{ steps.version.outputs.fix_version }} \
            --dart-define=BuildNo=${{ github.run_number }} \
            --dart-define=isPublish=false \
            --dart-define=isBeta=false \
            --dart-define=gitVersion=${{ github.sha }}
      - name: Rename APK with version
        run: |
          VERSION="${{ steps.version.outputs.major_version }}.${{ steps.version.outputs.minor_version }}.${{ steps.version.outputs.fix_version }}"
          BUILD="${{ github.run_number }}"
          # 直接在构建输出目录重命名APK
          cd ${{ github.workspace }}/tdesign-component/example/build/app/outputs/flutter-apk/
          mv app-release.apk tdesign-flutter-${VERSION}-${BUILD}.apk
          echo "APK renamed to: tdesign-flutter-${VERSION}-${BUILD}.apk"
          ls -la tdesign-flutter-${VERSION}-${BUILD}.apk
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: tdesign-flutter-apk
          path: ${{ github.workspace }}/tdesign-component/example/build/app/outputs/flutter-apk/tdesign-flutter-*.apk
          compression-level: 0

      - name: demo tools build api md
        run: |
          cd $GITHUB_WORKSPACE/tdesign-component/demo_tool
          # Make sure binary files are not symlinks
          if [ -L ./bin/api_tool_linux ]; then
            echo "Error: api_tool_linux is a symlink. This may be a Git configuration issue."
            echo "Please check if Git LFS is properly configured or if the file should be a regular file."
            exit 1
          fi
          chmod +x ./bin/api_tool_linux
          sh all_build.sh
      
      - name: Build site
        working-directory: ./tdesign-site
        run: |
          npm install --unsafe-perm
          npm run site

      - name: Build site Demo
        working-directory: ./tdesign-component/example
        run: |
          flutter build web -t ./lib/main.dart --base-href /flutter/example/ --source-maps
          echo "=== Files in tdesign-site ==="
          ls -la tdesign-site/ || echo "Directory not found"
          echo "=== Files in tdesign-component ==="
          ls -la tdesign-component/ || echo "Directory not found"
          # Ensure output directory exists at workspace root and copy built artifacts
          cd $GITHUB_WORKSPACE
          mkdir -p tdesign-flutter-web/flutter/example/
          cp -r tdesign-site/_site/* tdesign-flutter-web/ || echo "tdesign-site/_site/ not found or empty"
          rm -rf tdesign-flutter-web/assets || echo "tdesign-site/_site/assets not found or empty"
          # 重写 index.html 内容: 插入 <base href="/">（如果不存在），并把资源引用从绝对路径 /flutter/... 改为相对路径 flutter/...
          for f in \
            "$GITHUB_WORKSPACE/tdesign-flutter-web/index.html"; do
            if [ -f "$f" ]; then
              echo "Rewriting $f"
              # 如果没有 base 标签，则在 X-UA-Compatible 后面插入
              if ! grep -q '<base href="/">' "$f"; then
                sed -i 's|<meta http-equiv="X-UA-Compatible" content="ie=edge">|<meta http-equiv="X-UA-Compatible" content="ie=edge">\n  <base href="/">|' "$f" || true
              fi
              # 把 src="/flutter/..." 和 href="/flutter/..." 改为不带前导斜杠
              sed -i "s|src=\"/flutter/|src=\"flutter/|g; s|href=\"/flutter/|href=\"flutter/|g; s|src='/flutter/|src='flutter/|g; s|href='/flutter/|href='flutter/|g" "$f" || true
            else
              echo "$f not found, skipping"
            fi
          done
          cp -v tdesign-site/_site/index.html tdesign-flutter-web/404.html || echo "tdesign-site/_site/index.html not found or empty"
          cp -v tdesign-site/_site/index.html tdesign-flutter-web/200.html || echo "tdesign-site/_site/index.html not found or empty"
          cp -r tdesign-site/_site/assets tdesign-flutter-web/flutter/assets || echo "tdesign-site/_site not found or empty"
          cp -r tdesign-component/example/build/web/* tdesign-flutter-web/flutter/example/ || echo "example build web output not found"
          # 在仓库根写入 CNAME，用于静态托管重写规则
          echo '/* /index.html 200' > "$GITHUB_WORKSPACE/CNAME" || true
          echo "Wrote $GITHUB_WORKSPACE/CNAME"
      - uses: actions/upload-artifact@v4
        with:
          name: tdesign-flutter-web
          path: ${{ github.workspace }}/tdesign-flutter-web
          retention-days: 5
